package tp.pr3.ProgramCompiler.instruction;

import tp.pr3.bytecode.GoTo;
import tp.pr3.exception.*;
import tp.pr3.programcompiler.*;
import tp.pr3.programcompiler.condition.*;
/**
 * Clase que implementa la instrucción While.
 * @author Carlos Moreno
 * @author Manuel Suárez
 * @version 15/01/2017
 */
public class While implements Instruction{
	Condition condition;
	ParsedProgram whileBody;
	
	final int NUMCOMPONENTES = 4;
	/**
	 * Constructores de la clase.
	 */
	public While(){ }
	public While(Condition cnd, ParsedProgram wBody){
		this.condition = cnd;
		this.whileBody = wBody;
	}
	/**
	 * Método que parsea la instrucción.
	 * @param words: instrucción introducida en el programa.
	 * @param lexParser encargada del análisis léxico.
	 * @return Instruction dependiendo de si coincide con la instrucción de esta clase.
	 * @throws ArrayException 
	 * @throws LexicalAnalysisException 
	 */
	public Instruction lexParse(String[] words, LexicalParser lexParser) 
			throws ArrayException, LexicalAnalysisException{
		if (words.length != NUMCOMPONENTES || 
				!words[0].equalsIgnoreCase("WHILE")) return null;

		Condition cnd = ConditionParser.parse(words[1], words[2], 
				words[3], lexParser);
		
		if (cnd == null) return null;
		
		ParsedProgram wBody = new ParsedProgram();
		lexParser.increaseProgramCounter();
		lexParser.lexicalParser(wBody, "ENDWHILE");
		lexParser.increaseProgramCounter();
		
		return new While(cnd, wBody);
	}
	/**
	 * Método que compila la instrucción.
	 * @param compiler
	 * @throws ArrayException
	 * @throws VariableTableOverflow
	 * @throws NonexistentVariable 
	 */
	public void compile(tp.pr3.programcompiler.programcompiler.Compiler compiler) 
			throws ArrayException, VariableTableOverflow, NonexistentVariable{
		
		int pc1 = compiler.getProgramCounter();
		this.condition.compile(compiler);
		compiler.compile(this.whileBody);
		compiler.addByteCode(new GoTo(pc1));
		this.condition.setJump(compiler.getProgramCounter());
	}
	/**
	 * Método que genera un String de la instrucción.
	 */
	public String toString(){
		String s = "while " + this.condition.toString() + '\n' + this.whileBody.toString()
				+ "endwhile";
		return s;
	}
}
