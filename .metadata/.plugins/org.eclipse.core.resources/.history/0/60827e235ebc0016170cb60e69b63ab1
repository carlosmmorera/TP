package tp.pr2.CPU;

import tp.pr2.ByteCode.ByteCode;
import tp.pr2.ByteCode.ByteCodeProgram;

/**
 * Clase que gestiona la ejecución de las instrucciones bytecode
 * @author Carlos Moreno
 * @author Manuel Suárez
 * @version 17/11/2016
 *
 */
public class CPU {
	/**
	 * Memoria es un objeto de la clase @see TP.PR1.MV.Memory
	 * pila es un objeto de la clase @see TP.PR1.MV.OperandStack
	 * end es un booleano que indica cuando acaba la ejecución 
	 * de las intrucciones bytecode
	 */
	private Memory memoria;
	private OperandStack pila;
	private boolean end;
	private int programCounter;
	private ByteCodeProgram bcProgram;
	
	/**
	 * Constructor de la clase
	 */
	public CPU(){
		this.memoria = new Memory();
		this.pila = new OperandStack();
		this.end = false;
		this.programCounter = 0;
		this.bcProgram = null;
	}
	/**
	 * Método que ejecuta la instrucción bytecode dada
	 * @param instr instrucción a ejecutar
	 * @return un booleano dependiendo de si la ejecución fue correcta 
	 */
	public boolean run(){
		
	}
	public boolean haynelempila(int n){
		return n <= this.pila.getnumoperand();
	}
	public boolean execute(ByteCode instr){
		ENUM_BYTECODE inst = instr.getEnum();
		int op2 = 0;
		
		//Dependiendo de la instrucción ejecuto un método u otro
		switch (inst){
		//Para push introduzco en la cina de la pila el parámetro dado
		case PUSH: if (pila.push(instr.getParam())) return true;
		else return false;
		//Llamo al método de esta clase
		case LOAD: return this.load(instr.getParam());
		//Si hay elementos en la pila los escribo en memoria en la posición dada
		case STORE: if (!pila.vacia()) 
			return this.memoria.write(instr.getParam(), pila.pop());
			else return false; 
		//Saca por pantalla el elemento de la cima de la pila
		case OUT: if (!pila.vacia()) {
					System.out.println(Integer.toString(pila.pop()));
					return true;
				}
				else return false;
		//Acaba la ejecución de un programa
		case HALT: this.end = true; return true;
		default: return false;
		}
	}
	/**
	 * Método que implementa la instrucción LOAD
	 * @param pos posición de memoria
	 * @return un booleano si la carga fue corr ecta
	 */
	public boolean load(int pos){
		//Leo el elemento de memoria
				int elem = this.memoria.read(pos);
				return this.pila.push(elem);
	}
	/**
	 * Método que muestra el estado de la CPU, mostrando el de la pila y memoria
	 */
	public String toString(){
		String cadena = "Estado de la CPU:\n";
		cadena += this.memoria.toString();
		cadena += this.pila.toString();
		return cadena;
	}
	/**
	 * 
	 * @return un booleano dependiendo de si se ha detenido
	 *  la ejecución de un programa por ejecutar HALT
	 */
	public boolean getEnd(){
		return this.end;
	}
	public ByteCode getInstr(){
		return this.bcProgram.getbcatn(this.programCounter);
	}
	public int pilapop(){
		return pila.pop();
	}
	public boolean push(int n){
		return pila.push(n);
	}
}
